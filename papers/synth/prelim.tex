In this section, we will present the model of VTS from~\cite{PloS,SASB}.
%
We will also present the constrains and properties on the VTSs, and their
encoding as a QBF formula.   
%
We model a VTS as labelled graph along with assisting pairing matrices and
activating functions.

\begin{df}
  A VTS $G$ is a tuple $(\nodes,\mols,\edges,\nlabel,\pairs,\edgef,\nodef)$, where
  \begin{itemize}
  \item $\nodes$ is a set of nodes representing compartments in the VTS,
  \item $\mols$ is the set of molecules flowing in the system, 
  \item $\edges \subseteq \nodes \times (\powerset{\mols}-\emptyset) \times \nodes$ is the
    set of edges with molecule sets as labels,
  \item $\nlabel : \nodes \maps \powerset{\mols}$ defines the molecules present in the nodes,
  \item $\pairs \subseteq \mols \times \mols$ is pairing relation,
  \item $\nodef : \mols \maps \powerset{\mols} \maps \booleans$ is activity maps for nodes, and
  \item $\edgef : \mols \maps \powerset{\mols} \maps \booleans $ is activity maps for edges.
  \end{itemize}
\end{df}
$\nodes$, $\mols$, $\edges$, and $\nlabel$ define a labelled graph.
%
Additionally, $\pairs$ defines which molecules can fuse with which molecules,
and
$\nodef$ and $\edgef$ are the activity functions for molecules on
nodes and edges respectively.
%
The model captures the study state of a VTS.
%
The analysis of the model will inform us about the network/graph
properties of VTSs.

Let $\pairs(M')$ denote $\{m|(m,m') \in P \text{ and } m' \in M'\}$.
%
A molecule $k$ is {\em active} at node $n$ if $k \in \nlabel(n)$ and
$\nodef(k,\nlabel(n))$ is true.
%
A molecule $k$ is {\em active} at edges $(n,M',n')$ if $k \in M'$ and
$\edgef(k,M')$ is true.
%
We call $G$ {\em well-structured} if molecules $M$ is divided into
two equal-sized partitions $M_1$ and $M_2$ such that
$P \subseteq M_1 \times M_2$, and
for each $(n,M',n') \in \edges$, $n \neq n'$ and
$M' \subseteq \nlabel(n) \intersection \nlabel(n')$.
%
In other words,
no molecule can participate in fusion from both channels and
compartments,
%
there are no self loops, and 
each edge carry only those molecules that are present in its source
and destination nodes. 
%
An edge $(n,M',n') \in \edges$ {\em fuses} with its destination node $n'$
if there are molecules $m,m' \in \mols$ such that $m$ is active in
$(n,M',n')$, $m'$ is active in $n'$, and $(m,m') \in \pairs$.
%
We call $G$ {\em well-fused} if each edge $(n,M',n') \in \edges$ fuses
with non-empty fusing molecules $M'' \subseteq M'$
and $\pairs(M'')$ are not active in any other node.

% We will also consider several variations of the model.
% %
% For example, unique edge between two nodes, activity of molecules is
% not constrained by $\nodef$ and $\edgef$, etc.
%

A {\em path} in $G$ is a sequence $n_1,...,n_\ell$ of nodes 
such that $(n_i,\_,n_{i+1}) \in \edges$ for each $ 0 < i < \ell$.
%
For a molecule $m \in M$,
an {\em $m$-path} in $G$ is a sequence $n_1,...,n_\ell$ of nodes 
such that $(n_i,M',n_{i+1}) \in \edges$ and $m \in M'$ for
each $ 0 < i < \ell$.
%
A node $n'$ is {\em ($m$-)reachable} from node $n$ in $G$ if there is a ($m$-)path
$n,...,n'$ in $G$.
%
% A node $n'$ is {\em $m$-reachable} from node $n$ in $G$ if there is a
% $m$-path $n,...,n'$ in $G$.
%
We call $G$ {\em stable} if for each $(n,M',n') \in \edges$ and $m \in M'$,
$n$ is $m$-reachable from $n'$.
%
We call $G$ {\em connected} if for each $n,n' \in \nodes$,
$n'$ is reachable from $n$ in $G$.
%
We call $G$ $k$-connected if for each $\edges' \subseteq \edges$ and $|\edges'| < k$,
VTS $(\nodes,\mols,\edges-E',\nlabel,\pairs,\edgef,\nodef)$ is connected.



%
% In the definition, we do not care about the paths to be $m$-connected for some $m$.  
% %
% A variant of the definition may be sensitive to the $m$-connectedness, but
% we are not considering the variation.


\subsection{Encoding VTS}

The conditions on the VTSs for a given size can be encoded as a QBF formula
with uninterpreted functions.
%
To encode the constraints, we need variables for each aspect of
VTS.
%
Let us suppose that the size of the graph is $\nu$ and number of
molecules is $\mu$.
%
To fully finitize the problem, we also limit the maximum number $\pi$
of edges present between two nodes.
%
Here, we list the Boolean variables and uninterpreted function symbols
that encode parts of VTSs.
\begin{enumerate}

\item Boolean variable $n_{i,m}$ indicates if $m \in \nlabel(i)$
\item Boolean variable $e_{i,j,q}$ indicates if $q$th edge exists between $i$ and $j$.
\item Boolean variable $e_{i,j,q,m}$ indicates if $q$th edge between $i$ and $j$ contains $m$.
\item Boolean variable $p_{m,m'}$ indicates if $(m,m') \in \pairs$
\item uninterpreted Boolean functions $\nodef_m : \booleans^\mu \maps \booleans$
encoding $\nodef(m)$ map
\item uninterpreted Boolean functions $\edgef_m : \booleans^\mu \maps \booleans$
encoding $\edgef(m)$ map
\end{enumerate}
We also have auxiliary Boolean variables that will help us encode the well-fused property. 
\begin{enumerate}
\item $a_{i,m}$ indicates that molecule $m$ is active at node $i$, i.e., $\nodef(m,L(i))$
  holds
\item $b_{i,j,q,m}$ indicates that molecule $m$ is active at $q$th edge $(i,M',j)$ between $i$ and $j$, i.e., $\edgef(m,M')$ holds
\end{enumerate}

We will describe several constraints that encode VTSs in this section.
%
In the next section, we will extend the encoding for the synthesis problem.
%
To avoid cumbersome notation, we will not explicitly write the ranges
of the indexing in the constraints.
%
$i$ and $j$ will range over nodes, i.e., from $1$ to $\nu$.
%
$m$ will range over molecules, i.e., from $1$ to $\mu$.
%
$q$ will range over edges between two nodes, i.e., from $1$ to $\pi$.
%

The following constraints encode the basic consistency of VTSs.
\begin{align*}
  \texttt{EdgeC} =\;& \bigwedge\limits_{i,j,q} (\bigvee_m e_{i,j,q,m} )\limplies e_{i,j,q}
  \land
  \bigwedge\limits_{i,q} \neg e_{i,i,q}
  \land
  % \tag{\texttt{NodeC}}\label{eq:f0}\\
  \bigwedge\limits_{\mathclap{i,j,q,m}} e_{i,j,q,m} \limplies (n_{i,m} \land n_{j,m} )
  \\
  \texttt{ActivityC} =\;&
  \bigwedge\limits_{\mathclap{i,j,q,m}} b_{i,j,q,m} \limplies e_{i,j,q,m} \quad\land\quad
  \bigwedge\limits_{i,m} a_{i,m} \limplies n_{i,m}
  % \tag{V2}\label{eq:f1}\\
  \\
  \texttt{PairingC} =\;&
  \bigwedge\limits_{m} 
  (\Lor\limits_{m'} p_{mm'} \limplies \Land_{m'} \lnot p_{m'm} ) \land
  (\Lor\limits_{m'} p_{m'm} \limplies \Land_{m'} \lnot p_{mm'} )
  \\
  \texttt{Fusion1} =\;&
  \bigwedge\limits_{i,j,q} e_{i,j,q} \limplies
  \bigvee_{\mathclap{m,m^{\prime}}} (b_{i,j,q,m} \land a_{j,m^{\prime}} \land p_{m,m^{\prime}})
  \\
  \texttt{Fusion2} =\;&
\bigwedge\limits_{\mathclap{i,j,q,m}} b_{i,j,q,m} \limplies \neg 
  \bigvee_{\mathclap{j \neq j^{\prime}, m^{\prime\prime}}} ( a_{j^{\prime},m^{\prime\prime}} \land p_{m,m^{\prime\prime}})
  \\
  \texttt{Consistancy} =\;& \texttt{EdgeC} \land
  \texttt{ActivityC} \land \texttt{PairingC} \land
  \texttt{Fusion1} \land \texttt{Fusion2} 
\end{align*}
\texttt{EdgeC} states that each edge has at least one molecule,
there are no self loops, and edge labels are consistent with node labels.   
\texttt{ActivityC} states that active molecule are present.
\texttt{PairingC} states that a molecule can either participate in fusion
via nodes or via edges, but not both.
\texttt{Fusion1}, and \texttt{Fusion2} states the well-fused condition.
\texttt{Consistancy} is the conjunction of all of the above.

\paragraph{Activity functions}
We also need to encode that
the activity of the molecules are controlled by activity functions.
%
However, the encoding functions can be given to us many different ways,
for example as a lookup table, or a concise Boolean formula.
%
In the following section, we will assume the appropriate encoding is
used for the functions and represent them by \texttt{NodeFun}$_m$
and \texttt{EdgeFun}$_m$ for node and edge regulations respectively.
%
We will use $\nodef_m$ and $\edgef_m$ to represent functions that
are not defined in a VTS.
%
% \begin{align}
% \bigwedge\limits_{i,m} n_{i,m} \limplies a_{i,m} =  \nodef_m (n_{i,1},\dots,n_{i,\mu}) 
% \tag{\texttt{ActiveN}}\label{eq:anb}\\
%    \bigwedge\limits_{i,j,q,m} e_{i,j,q,m} \limplies b_{i,j,q,m} = \edgef_m(e_{i,j,q,1}, .., e_{i,j,q,\mu} )
%   \tag{\texttt{ActiveE}}\label{eq:aeb}
% \end{align}
%
Later we will be synthesizing missing activity functions and 
replace $\nodef_m$ and $\edgef_m$ with parameterized constraints that
encode a space of candidate functions.

\subsection{VTS properties}

For synthesis of incomplete systems,
we need properties  against which we synthesize the missing parts.
%
Here we will discussed two such properties proposed in earlier
works~\cite{SASBpaper}, namely stability and $k$-connectedness.
%

\paragraph{Stability property}
%
We use Boolean variable $r_{i,j,m,p}$ to indicate if there is an
$m$-path from $i$ to $j$ of length less than or equal to $p$.
%
We use $m$-reachability to encode the stability condition in VTSs.
%
The following constraint recursively encodes that node $j$ is
$m$-reachable from node $i$ in less than $p$ steps.
%
Subsequently, we encode stability condition using the reachability variables.
\begin{align*}
  \texttt{paths}(r) &= \bigwedge\limits_{\mathclap{i,j,m,p}} r_{i,j,m,p} \limplies (\bigvee_{q} \, e_{i,j,q,m} \lor \bigvee_{i\neq i^{\prime}} ( \, \bigvee_{q} e_{i,i^{\prime},q,m}) \land r_{i^{\prime},j,m,p-1} )
  \\
  \texttt{loop}(r) &= \bigwedge\limits_{i,j,m} (\bigvee_{q} e_{i,j,q,m}) \limplies r_{j,i,m,\nu}
  \\
  \texttt{stability} &= \exists r. \; \texttt{paths}(r) \land \texttt{loop}(r)
\end{align*}

\paragraph{$k$-connected property}
%
$k$-connectedness expresses robustness against failure of few edges.
%
Let us use $d_{i,j,q}$ to indicate $q$th edge between $i$ and $j$ is failed
and $r'_{i,j}$ to indicate if there is a path from $i$ to $j$ in
the modified VTS.
%
% To check whether $k$-connected is a
% necessary condition, we remove (drop) $k-1$ edges from the graph and
% if it disconnects the graph, and we get an assignment.
% %
% We have a graph that is not $k$-connected.
%
In the following, $\texttt{Fail}(d,k)$ encodes that only
existing edges can be failed and exactly $k-1$ edges are failed.
%
$\texttt{FailReach}(d,r')$ defines reachability in the modified VTS.
%
We use a new variable $r'_{i,j,p}$ to encode reachability from
$i$ to $j$ in at most $p$ steps.
%
$\texttt{Connected}(r')$ says that all nodes are reachable from any
other node.
\begin{align*}
  \texttt{fail}(d,k) = & 
  \bigwedge\limits_{i,j,q} d_{i,j,q} \limplies e_{i,j,q}  \land 
  \sum_{i,j,q} d_{i,j,q} = k-1\\
  % \texttt{ReachAbove}(d,r') = &
  % \bigwedge\limits_{i,j}  [\bigvee_{q} (e_{i,j,q} \land  \neg d_{i,j,q}) \lor  (\bigvee_{i' \neq i}  r^{\prime}_{i',j} \land  \bigvee_{q} (e_{i,i',q} \land \neg d_{i,i',q}) ] \limplies r^{\prime}_{i,j}\\
  \texttt{failReach}(d,r') = &
   \bigwedge\limits_{i,j,p}  r^{\prime}_{i,j,p} \limplies [\bigvee_{q} (e_{i,j,q} \land  \neg d_{i,j,q}) \lor  (\bigvee_{i' \neq i}  r^{\prime}_{i',j,p-1} \land  \bigvee_{q} (e_{i,i',q} \land \neg d_{i,i',q}) ]\\
  \texttt{connected}(r') = & \Land\limits_{i,j} (r^{\prime}_{i,j,\nu} \lor r^{\prime}_{j,i,\nu})
\end{align*}
We will be synthesizing $k$-connected graphs.
%
We define $\texttt{connected}(k)$ that says for all possible valid failures
the graph remains reachable. 
\begin{align*}
  \texttt{connected}(k) = & \forall d.\;
          (\texttt{fail}(d,k) \limplies \exists r'.\;\texttt{failReach}(d,r')
                                \land \texttt{connected}(r'))
% \\
  % \texttt{Disconnected}(k) = & \exists d.\;
  %         (\texttt{Drop}(d,k) \land \exists r'.\;\texttt{ReachAbove}(d,r')
  %                               \land \lnot \texttt{Connected}(r'))
\end{align*}
Since $d$ variables in $\texttt{connected}(k)$ are universally
quantified, $\texttt{connected}(k)$ introduces quantifier alternations.
%


% \subsection{Solvers}
% Due the combinatorial nature of the graphs, the search space is huge
% and often hard to enumerate naively.
% %
% We need sophisticated solvers 


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
